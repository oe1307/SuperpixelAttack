#!/bin/sh

if [ $1 = "setup" ]; then
    mkdir -p $(dirname $0)/storage/data
    cd $(dirname $0)/storage/data
    if [ ! -e imagenet.tar.gz ]; then
        scp ds:/data0/issa/dataset/imagenet.tar.gz imagenet.tar.gz
    fi
    if [ ! -e imagenet ]; then
        tar -xzf imagenet.tar.gz
    else
        echo "-> imagenet already exists"
    fi

elif [ $1 = "install" ]; then
    cd $(dirname $0)
    pip install --upgrade pip
    pip freeze | xargs pip uninstall -y
    pip install -r requirements.txt

elif [ $1 = "format" ]; then
    echo && echo "----black-----"
    black $(dirname $0) -q
    echo && echo "----isort-----"
    isort $(dirname $0) -s ./run
    echo && echo "----flake8----"
    pflake8 $(dirname $0)
    echo

elif [ $1 = "test" ]; then
    if [ $# = 2 ]; then
        cd $(dirname $0)/src
        python attack.py -c config/default/AutoPGD.yaml -g $2 --thread 10 --log_level 10
    else
        echo "Usage: $0 test [gpu]"
        exit 1
    fi

else
    echo "Usage: $0 [setup|install|format|test]"
fi
